services:
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale-nextcloud
    hostname: nextcloud-app
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_SERVE_CONFIG=/config/serve.json
      - TS_USERSPACE=false
    volumes:
      - ./ts-config:/config
      - ./ts-state:/var/lib/tailscale
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
      - sys_module
    restart: unless-stopped

  nextcloud:
    image: nextcloud:apache
    container_name: nextcloud-app
    network_mode: service:tailscale
    depends_on:
      - tailscale
      - db
    environment:
      - POSTGRES_HOST=localhost
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=${NEXTCLOUD_TRUSTED_DOMAINS}
    volumes:
      - nextcloud:/var/www/html
    restart: unless-stopped

  db:
    image: postgres:latest
    container_name: nextcloud-db
    network_mode: service:tailscale
    environment:
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  nextcloud:
  postgres:
